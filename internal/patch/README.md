# Patch Package

The patch package provides functionality for parsing and applying patches to files. It supports a simple patch format that is easy for LLMs to generate and a more robust patch format for complex operations.

## Simple Patch Format

The simple patch format is designed to be easily generated by LLMs. It has a straightforward structure:

```
*** Begin Patch
*** Add File: path/to/new/file.go
+ package main
+
+ func main() {
+     fmt.Println("Hello, world!")
+ }
*** Update File: path/to/existing/file.go
Context line 1
Context line 2
- line to remove
+ line to add
Context line 3
*** Delete File: path/to/unwanted/file.go
*** End Patch
```

### Operation Types

1. **Add File**: Creates a new file with the specified content.
   - Each line of content must be prefixed with `+`
   - The content is the line minus the `+` prefix

2. **Update File**: Modifies an existing file.
   - Context lines (no prefix): Used for locating where to make changes in the file
   - Lines to delete (prefix `-`): Lines to be removed
   - Lines to add (prefix `+`): Lines to be inserted

3. **Delete File**: Removes a file.

4. **Move File**: (Implemented in the function API, not directly in the patch format)
   - Can be achieved by combining other operations or using the API directly

## API Usage

The patch package provides several functions to parse and apply patches:

### Parsing a Patch

```go
// Parse a patch from a string
operations, err := patch.ParseSimplePatch(patchText)
if err != nil {
    return err
}
```

### Applying a Patch

```go
// Process and apply a patch
results, err := patch.ProcessPatch(patchText)
if err != nil {
    return err
}

// Check the results
for _, result := range results {
    if !result.Success {
        fmt.Printf("Failed to apply %s operation to %s: %v\n", 
            result.OperationType, result.FilePath, result.Error)
    }
}
```

### Advanced API

For more control over patch operations, you can use the lower-level API:

```go
// Apply individual operations
addOp := &patch.PatchOperation{
    Type:    "add",
    Path:    "path/to/new/file.txt",
    Content: "This is file content",
}
err = patch.applyAddOperation(*addOp)

moveOp := &patch.PatchOperation{
    Type:   "move",
    Path:   "path/to/source.txt",
    MoveTo: "path/to/destination.txt",
}
err = patch.applyMoveOperation(*moveOp)
```

## Robustness Features

The patch system includes several features to improve robustness:

1. **Context-aware updates**: When updating a file, the system uses the context lines to locate the right position to make changes.

2. **Fuzzy matching**: If exact context matching fails, the system will attempt fuzzy matching to find the best location to apply changes.

3. **Directory creation**: When creating or moving files, missing directories are automatically created.

4. **Error handling**: Detailed error reporting helps identify issues when applying patches.

## Examples

See the `internal/patch/integration_test.go` file for examples of how to use the patching system. 